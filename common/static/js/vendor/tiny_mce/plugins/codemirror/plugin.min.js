/**
 * plugin.js
 *
 * Copyright 2013 Web Power, www.webpower.nl
 * @author Arjan Haverkamp
 */

/*jshint unused:false */
/*global tinymce:true */

tinymce.PluginManager.requireLangPack('codemirror');

tinymce.PluginManager.add('codemirror', function(editor, url) {

	function showSourceEditor() {
		// Insert caret marker
		editor.focus();
		editor.selection.collapse(true);
		editor.selection.setContent('<span class="CmCaReT" style="display:none">&#0;</span>');

		// Open editor window
		var win = editor.windowManager.open({
			title: 'HTML source code',
			url: url + '/source.html?'+editor.settings.codemirror.path,
			width: 800,
			height: 550,
			resizable : true,
			maximizable : true,
			buttons: [
				{ text: 'Ok', subtype: 'primary', onclick: function(){
					var doc = document.querySelectorAll('.mce-container-body>iframe')[0];
					doc.contentWindow.submit();
					win.close();
                    console.log('remove listener');
                    window.removeEventListener("message", messageListener);
				}},
				{ text: 'Cancel', onclick: function() {
//                  TODO: Need to handle close in upper corner too...
                    win.close();
                    window.removeEventListener("message", messageListener);
                } }
			]
		});

//      Why doesn't win.getContentWindow() work?? Is it not in our version?
        var codeWindow = win.getEl().getElementsByTagName('iframe')[0].contentWindow;

        var messageListener = function (event) {
            console.log('RECEIVED EVENT ' + event.data.type);
            if (event.data.type === "init") {
                codeWindow.postMessage(
                    {
                        type: "init",
                        settings: editor.settings.codemirror,
                        content: editor.getContent({source_view: true})
                    },
                    "*"
                );
            }
            else if (event.data.type === "setText") {
                editor.setContent(event.data.text);
            }
        };

        window.addEventListener("message", messageListener, false);

	};

	// Add a button to the button bar
    // EDX changed to show "HTML" on toolbar button
	editor.addButton('code', {
		title: 'Edit HTML',
        text: 'HTML',
		icon: false,
		onclick: showSourceEditor
	});

	// Add a menu item to the tools menu
	editor.addMenuItem('code', {
		icon: 'code',
		text: 'Edit HTML',
		context: 'tools',
		onclick: showSourceEditor
	});
});
